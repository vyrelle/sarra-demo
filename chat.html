<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="title">SARRA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sidebar-transition {
      transition: transform 0.3s ease-in-out;
    }
    .overlay {
      transition: opacity 0.3s ease-in-out;
    }
    .chat-message {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #8f6451;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .star {
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .star:hover {
      color: #ffd700;
    }
    .star.active {
      color: #ffd700;
    }
    .chat-item {
      transition: all 0.3s ease;
    }
    .chat-item.deleting {
      transform: translateX(-100%);
      opacity: 0;
    }
    .delete-btn {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .chat-item:hover .delete-btn {
      opacity: 1;
    }
    .rate-button {
      background-color: rgba(143,100,81,0.1);
      color: #8f6451;
      font-size: 0.875rem;
    }
    .rate-button:hover {
      background-color: rgba(143,100,81,0.2);
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
    }
  </style>
</head>
<body class="bg-[#fdfcf9] font-sans">
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden overlay"></div>

  <div id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-[rgba(230,220,200,0.9)] text-[#35221b] z-50 sidebar-transition transform -translate-x-full">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-[#b9a892]">
        <a href="index.html" class="text-xl font-bold tracking-widest font-[system-ui] text-[#35221b]" data-i18n="title">SARRA</a>
        <button id="closeSidebar" class="p-2 hover:bg-[#d0bca3] rounded">
          <svg class="w-5 h-5 text-[#35221b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-4">
        <button id="newChatBtn" class="w-full flex items-center gap-3 p-3 bg-[rgba(143,100,81,0.15)] hover:bg-[rgba(143,100,81,0.3)] rounded-lg transition-colors text-[#35221b]">
          <svg class="w-5 h-5 text-[#35221b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span data-i18n="new_chat">New Chat</span>
        </button>
      </div>
      
      <div class="px-4 pb-4">
        <div class="relative">
          <input type="text" id="searchInput" data-i18n-placeholder="search_chats" placeholder="Search chats..." class="w-full bg-white text-[#35221b] placeholder-[#8f6451] rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-[#8f6451]">
          <svg class="w-4 h-4 absolute left-3 top-3 text-[#8f6451]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto">
        <div class="px-4 pb-2">
          <h3 class="text-lg font-medium text-[#8f6451] mb-3" data-i18n="history">History</h3>
        </div>
        <div id="chatHistory" class="px-4 space-y-2">
        </div>
      </div>
      
      <div class="p-4 border-t border-[#b9a892]">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-[#8f6451] rounded-full flex items-center justify-center">
            <span class="text-sm font-medium text-white">Ð£</span>
          </div>
          <span class="text-sm" data-i18n="user">User</span>
        </div>
      </div>
    </div>
  </div>

  <div id="mainContent" class="min-h-screen flex flex-col transition-all duration-300">
    <header class="bg-white border-b border-[#b9a892] p-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="openSidebar" class="p-2 hover:bg-[#d0bca3] rounded">
          <svg class="w-6 h-6 text-[#35221b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <h2 class="text-xl font-semibold text-[#35221b]" data-i18n="sarra_assistant">SARRA Assistant</h2>
      </div>
    </header>
    
    <div class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
      <div id="welcomeScreen" class="flex-1 flex items-center justify-center p-8">
        <div class="text-center">
          <h3 class="text-2xl font-bold text-[#35221b] mb-2"
              style="text-shadow: 3px 3px 15px rgba(189, 157, 127, 0.6);"
              data-i18n="welcome_message">
            Welcome to SARRA!
          </h3>
          <p class="text-[#8f6451] mb-8"
            style="text-shadow: 2px 2px 10px rgba(189, 157, 127, 0.4);"
            data-i18n="welcome_description">
            I'm ready to help you with any questions. Start a new conversation below.
          </p>
        </div>
      </div>

      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
      </div>

      <div id="questionBlock" class="p-4 border-t border-[#b9a892] bg-white">
        <div class="max-w-4xl mx-auto">
          <div class="relative">
            <textarea 
              id="messageInput"
              data-i18n-placeholder="message_placeholder"
              placeholder="Write your question..." 
              class="w-full resize-none border border-[#b9a892] rounded-lg px-4 py-3 pr-12 focus:outline-none focus:ring-2 focus:ring-[#8f6451] focus:border-transparent"
              rows="1"
            ></textarea>
            <button id="sendButton" class="absolute right-2 top-2 p-2 bg-[#8f6451] text-white rounded-lg hover:bg-[#35221b] transition-colors disabled:bg-gray-300">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            </button>
          </div>
          <div class="text-xs text-[#8f6451] mt-2 text-center" data-i18n="disclaimer">
            SARRA can make mistakes. Check important information.
          </div>
        </div>
      </div>

      <div id="ratingBlock" class="modal hidden p-6">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-semibold text-[#35221b]" data-i18n="rate_answer">Rate Answer</h4>
          <button id="closeRatingModal" class="p-2 hover:bg-[#d0bca3] rounded">
            <svg class="w-5 h-5 text-[#35221b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-[#35221b] mb-2" data-i18n="rating">Rating:</label>
          <div class="flex gap-1" id="starRating">
            <span class="star text-2xl text-gray-300" data-rating="1">â˜…</span>
            <span class="star text-2xl text-gray-300" data-rating="2">â˜…</span>
            <span class="star text-2xl text-gray-300" data-rating="3">â˜…</span>
            <span class="star text-2xl text-gray-300" data-rating="4">â˜…</span>
            <span class="star text-2xl text-gray-300" data-rating="5">â˜…</span>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-[#35221b] mb-2" data-i18n="your_feedback">Your feedback</label>
          <textarea 
            id="commentInput" 
            class="w-full border border-[#b9a892] rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#8f6451]"
            rows="3"
          ></textarea>
        </div>

        <button id="submitFeedback" class="bg-[#8f6451] text-white px-6 py-2 rounded-lg hover:bg-[#35221b] transition-colors" data-i18n="submit">
          Submit
        </button>
      </div>

      <div id="modalOverlay" class="modal-overlay hidden"></div>
    </div>
  </div>

  <script src="i18n.js"></script>
  <script>
    let currentChatId = null;
    let chats = JSON.parse(localStorage.getItem('sarraChats') || '[]');
    let currentRating = 0;

    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const openSidebarBtn = document.getElementById('openSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebar');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatMessages = document.getElementById('chatMessages');
    const questionBlock = document.getElementById('questionBlock');
    const ratingBlock = document.getElementById('ratingBlock');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeRatingModal = document.getElementById('closeRatingModal');

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    overlay.addEventListener('click', closeSidebar);

    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      welcomeScreen.classList.add('hidden');
      chatMessages.classList.remove('hidden');

      addMessage('user', message);
      
      messageInput.value = '';
      messageInput.style.height = 'auto';

      showLoader();
      setTimeout(() => {
        hideLoader();
        const botResponse = generateBotResponse(message);
        addMessage('bot', botResponse);
        addRateButton();
      }, 2000);

      if (!currentChatId) {
        createNewChat(message);
      }
    }

    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
      
      const messageContent = document.createElement('div');
      messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
        sender === 'user' 
          ? 'bg-[#8f6451] text-white' 
          : 'bg-white border border-[#b9a892] text-[#35221b]'
      }`;
      messageContent.textContent = text;
      
      messageDiv.appendChild(messageContent);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addRateButton() {
      const existingRateButton = document.querySelector('#rateAnswerBtn');
      if (existingRateButton) {
        existingRateButton.removeEventListener('click', showRatingBlock);
      }

      const rateDiv = document.createElement('div');
      rateDiv.className = 'chat-message flex justify-start mt-2';
      const uniqueId = `rateAnswerBtn-${Date.now()}`; 
      rateDiv.innerHTML = `
        <button id="${uniqueId}" class="flex items-center gap-2 px-3 py-1 rate-button rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
          </svg>
          <span>${i18n.t('rate_answer')}</span>
        </button>
      `;
      chatMessages.appendChild(rateDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      document.getElementById(uniqueId).addEventListener('click', showRatingBlock);
    }

    function showLoader() {
      const loaderDiv = document.createElement('div');
      loaderDiv.id = 'loader';
      loaderDiv.className = 'chat-message flex justify-start';
      loaderDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-[#b9a892] flex items-center gap-2">
          <div class="loader"></div>
          <span class="text-[#35221b]">${i18n.t('generating_response')}</span>
        </div>
      `;
      chatMessages.appendChild(loaderDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideLoader() {
      const loader = document.getElementById('loader');
      if (loader) loader.remove();
    }

    function generateBotResponse(question) {
      const responses = [
        'Ð”Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð»Ð¸Ñ‡Ð½Ð¾ Ð² ÐÐÐž Â«Ð“Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ ÐºÐ¾Ñ€Ð¿Ð¾Ñ€Ð°Ñ†Ð¸Ñ Â«ÐŸÑ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾ Ð´Ð»Ñ Ð³Ñ€Ð°Ð¶Ð´Ð°Ð½Â» Ð¸Ð»Ð¸ Ñ‚ÐµÑ€Ñ€Ð¸Ñ‚Ð¾Ñ€Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐœÐ’Ð” Ð Ðš. Ð£ÑÐ»ÑƒÐ³Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° ÐºÐ°Ðº Ð² Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¼, Ñ‚Ð°Ðº Ð¸ Ð² ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð½Ð¾Ð¼ Ð¿Ð¾Ñ€ÑÐ´ÐºÐµ, Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸. '
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    function showRatingBlock() {
      ratingBlock.classList.remove('hidden');
      modalOverlay.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function hideRatingBlock() {
      ratingBlock.classList.add('hidden');
      modalOverlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      document.getElementById('commentInput').value = '';
      currentRating = 0;
      updateStars();
    }

    document.getElementById('starRating').addEventListener('click', function(e) {
      if (e.target.classList.contains('star')) {
        currentRating = parseInt(e.target.dataset.rating);
        updateStars();
      }
    });

    function updateStars() {
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < currentRating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    closeRatingModal.addEventListener('click', hideRatingBlock);
    modalOverlay.addEventListener('click', hideRatingBlock);

    document.getElementById('submitFeedback').addEventListener('click', function() {
      const comment = document.getElementById('commentInput').value.trim();
      
      if (!comment) {
        alert(i18n.t('please_leave_feedback'));
        return;
      }

      if (currentRating === 0) {
        alert(i18n.t('please_rate'));
        return;
      }

      const isValid = Math.random() > 0.3; 
      showValidationResult(isValid);
      hideRatingBlock();
      questionBlock.classList.remove('hidden');
    });

    function showValidationResult(isValid) {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'chat-message flex justify-start mt-2';
      
      if (isValid) {
        resultDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-[#b9a892] flex items-center gap-2 text-green-600">
            <span class="text-2xl">ðŸŸ¢</span>
            <span class="font-medium">${i18n.t('accepted_validation')}</span>
          </div>
        `;
      } else {
        const reason = i18n.getRandomValidationReason();
        
        resultDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-[#b9a892] text-red-600">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-2xl">ðŸ”´</span>
              <span class="font-medium">${i18n.t('rejected_validation')}</span>
            </div>
            <div class="text-sm ml-8">${reason}</div>
          </div>
        `;
      }

      chatMessages.appendChild(resultDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      setTimeout(() => {
        resultDiv.remove();
      }, 3000);
    }

    function createNewChat(firstMessage) {
      const chatId = Date.now().toString();
      const chat = {
        id: chatId,
        title: firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : ''),
        messages: [],
        createdAt: new Date().toISOString()
      };
      
      chats.unshift(chat);
      currentChatId = chatId;
      saveChats();
      updateChatHistory();
    }

    function startNewChat() {
      currentChatId = null;
      
      chatMessages.innerHTML = '';
      chatMessages.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
      questionBlock.classList.remove('hidden');
      ratingBlock.classList.add('hidden');
      modalOverlay.classList.add('hidden');
      
      messageInput.value = '';
      document.getElementById('commentInput').value = '';
      currentRating = 0;
      updateStars();
      
      closeSidebar();
    }

    function saveChats() {
      localStorage.setItem('sarraChats', JSON.stringify(chats));
    }

    function updateChatHistory() {
      chatHistory.innerHTML = '';
      
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item p-3 hover:bg-[rgba(143,100,81,0.1)] rounded-lg cursor-pointer transition-colors relative group';
        chatItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0" onclick="loadChat('${chat.id}')">
              <div class="font-medium text-sm text-[#35221b] mb-1 truncate">${chat.title}</div>
              <div class="text-xs text-[#8f6451]">${new Date(chat.createdAt).toLocaleDateString()}</div>
            </div>
            <button class="delete-btn ml-2 p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors" 
                    onclick="deleteChat('${chat.id}', event)" title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        
        chatHistory.appendChild(chatItem);
      });
    }

    function loadChat(chatId) {
      console.log('Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ñ‡Ð°Ñ‚:', chatId);
      closeSidebar();
    }

    function deleteChat(chatId, event) {
      event.stopPropagation(); 
      
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;

      const isConfirmed = confirm(`${i18n.t('delete_chat_confirm')} "${chat.title}"?`);
      if (!isConfirmed) return;

      const chatElements = document.querySelectorAll('.chat-item');
      let chatElement = null;
      
      chatElements.forEach(element => {
        const deleteBtn = element.querySelector('.delete-btn');
        if (deleteBtn && deleteBtn.getAttribute('onclick').includes(chatId)) {
          chatElement = element;
        }
      });

      if (chatElement) {
        chatElement.classList.add('deleting');
        
        setTimeout(() => {
          chats = chats.filter(c => c.id !== chatId);
          saveChats();
          
          if (currentChatId === chatId) {
            startNewChat();
          }
          
          updateChatHistory();
        }, 300);
      } else {

        chats = chats.filter(c => c.id !== chatId);
        saveChats();
        
        if (currentChatId === chatId) {
          startNewChat();
        }
        
        updateChatHistory();
      }
    }

    sendButton.addEventListener('click', sendMessage);
    newChatBtn.addEventListener('click', startNewChat);

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const chatItems = chatHistory.children;
      
      Array.from(chatItems).forEach(item => {
        const titleElement = item.querySelector('.font-medium');
        if (titleElement) {
          const title = titleElement.textContent.toLowerCase();
          if (title.includes(searchTerm)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        }
      });
    });

    window.loadChat = loadChat;
    window.deleteChat = deleteChat;

    // Initialize i18n and update chat history
    document.addEventListener('DOMContentLoaded', () => {
      i18n.init();
      updateChatHistory();
    });

    updateChatHistory();
  </script>
</body>
</html>