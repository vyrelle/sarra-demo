<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SARRA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sidebar-transition {
      transition: transform 0.3s ease-in-out;
    }
    .overlay {
      transition: opacity 0.3s ease-in-out;
    }
    .chat-message {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4b5563; 
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .star {
      cursor: pointer;
      transition: color 0.2s ease;
    }
    .star:hover {
      color: #f7bc0d;
    }
    .star.active {
      color: #f7bc0d;
    }
    .chat-item {
      transition: all 0.3s ease;
    }
    .chat-item.deleting {
      transform: translateX(-100%);
      opacity: 0;
    }
    .delete-btn {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .chat-item:hover .delete-btn {
      opacity: 1;
    }
    .rate-button {
      background-color: rgba(75, 85, 99, 0.1); 
      color: #374151; 
      font-size: 0.875rem;
    }
    .rate-button:hover {
      background-color: rgba(75, 85, 99, 0.2);
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 40;
    }
  </style>
</head>
<body class="bg-white font-sans">

  <div id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-gray-900 text-white z-50 sidebar-transition transform -translate-x-full border-r border-gray-700">
    <div class="flex flex-col h-full">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <a href="index.html" class="text-xl font-bold tracking-widest text-white">SARRA</a>
        <button id="closeSidebar" class="p-2 hover:bg-gray-800 rounded">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="p-4">
        <button id="newChatBtn" class="w-full flex items-center gap-3 p-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors text-white">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>Новый чат</span>
        </button>
      </div>
      
      <div class="px-4 pb-4" id="searchSection">
        <div class="relative">
          <input type="text" id="searchInput" placeholder="Поиск чатов..." class="w-full bg-gray-800 text-white placeholder-gray-400 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-indigo-600 border border-gray-700">
          <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto" id="historySection">
        <div class="px-4 pb-2">
          <h3 class="text-lg font-medium text-white mb-3">История</h3>
        </div>
        <div id="chatHistory" class="px-4 space-y-2">
        </div>
      </div>

      <div id="guestMessage" class="p-4 border-t border-gray-700 hidden">
        <div class="text-center text-sm text-gray-400 mb-3">
          <p class="mb-2">Войдите, чтобы сохранять историю чатов</p>
          <button id="sidebarLoginBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
            Войти
          </button>
        </div>
      </div>
      
      <div class="p-4 border-t border-gray-700" id="userInfo">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
            <span class="text-sm font-medium text-white" id="userInitial">Г</span>
          </div>
          <div class="flex-1 min-w-0">
            <span class="text-sm text-gray-300" id="userEmail">Гость</span>
          </div>
          <button id="logoutBtn" class="p-1 text-gray-400 hover:text-white transition-colors hidden" title="Выйти">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="mainContent" class="min-h-screen flex flex-col transition-all duration-300 ml-0">
    <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="openSidebar" class="p-2 hover:bg-blue-100 rounded">
          <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <h2 class="text-xl font-bold tracking-widest text-gray-700">SARRA Assistant</h2>
      </div>
      
      <div id="headerLoginSection" class="flex items-center gap-2">
        <button id="headerLoginBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition-colors">
          Войти
        </button>
      </div>

      <div id="headerUserSection" class="hidden flex items-center gap-2">
        <span class="text-sm text-gray-600" id="headerUserEmail">user@email.com</span>
        <button id="headerLogoutBtn" class="text-gray-600 hover:text-gray-800 transition-colors" title="Выйти">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </header>
    
    <div class="flex-1 flex flex-col max-w-4xl mx-auto w-full">
      <div id="welcomeScreen" class="flex-1 flex flex-col justify-center items-center p-8 relative">
        <div class="flex flex-col items-center" style="transform: translateY(-60px); width: 100%;">
          <div class="text-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">
              Добро пожаловать в 
              <span class="text-xl font-bold tracking-widest text-gray-800">SARRA</span>!
            </h3>
          </div>

          <div class="w-full max-w-2xl relative">
            <textarea 
              id="messageInput" 
              placeholder="Задайте вопрос..." 
              class="w-full border rounded-full py-3 px-4 pr-12 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              rows="1"
            ></textarea>

            <button id="sendButton" 
              class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center w-10 h-10 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition-colors">
              ⭡
            </button>
          </div>
        </div>
      </div>

      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 hidden"></div>
      <div id="questionBlock" class="p-4 bg-white pb-8 hidden">
        <div class="max-w-4xl mx-auto">
          <div class="relative w-full flex justify-center">
            <textarea 
              id="chatInput" 
              placeholder="Задайте вопрос..." 
              class="w-full max-w-2xl border rounded-full py-3 px-4 pr-12 shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              rows="1"
            ></textarea>

            <button id="chatSendButton" 
              class="absolute right-[calc(50%-320px)] top-1/2 -translate-y-1/2 flex items-center justify-center w-10 h-10 bg-gray-600 text-white rounded-full hover:bg-gray-700 transition-colors disabled:bg-gray-400">
              ⭡
            </button>
          </div>
        </div>
      </div>

      <div id="ratingBlock" class="modal hidden p-6 bg-white rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-lg font-semibold text-gray-800">Оценить ответ</h4>
          <button id="closeRatingModal" class="p-2 hover:bg-gray-200 rounded">
            <svg class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Рейтинг:</label>
          <div class="flex gap-1" id="starRating">
            <span class="star text-2xl text-gray-300 cursor-pointer" data-rating="1">★</span>
            <span class="star text-2xl text-gray-300 cursor-pointer" data-rating="2">★</span>
            <span class="star text-2xl text-gray-300 cursor-pointer" data-rating="3">★</span>
            <span class="star text-2xl text-gray-300 cursor-pointer" data-rating="4">★</span>
            <span class="star text-2xl text-gray-300 cursor-pointer" data-rating="5">★</span>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Ваш отзыв</label>
          <textarea 
            id="commentInput" 
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-600"
            rows="3"
          ></textarea>
        </div>

        <button id="submitFeedback" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
          Отправить
        </button>
      </div>

      <div id="modalOverlay" class="modal-overlay hidden"></div>
    </div>
  </div>

  <script>
    let currentChatId = null;
    let chats = [];
    let currentRating = 0;
    let isLoggedIn = false;
    let currentUser = '';

    const sidebar = document.getElementById('sidebar');
    const openSidebarBtn = document.getElementById('openSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebar');
    const messageInput = document.getElementById('messageInput');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const chatSendButton = document.getElementById('chatSendButton');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatMessages = document.getElementById('chatMessages');
    const questionBlock = document.getElementById('questionBlock');
    const ratingBlock = document.getElementById('ratingBlock');
    const modalOverlay = document.getElementById('modalOverlay');
    const closeRatingModal = document.getElementById('closeRatingModal');
    const newChatBtn = document.getElementById('newChatBtn');
    const searchInput = document.getElementById('searchInput');
    const chatHistory = document.getElementById('chatHistory');

    const headerLoginBtn = document.getElementById('headerLoginBtn');
    const headerUserSection = document.getElementById('headerUserSection');
    const headerLoginSection = document.getElementById('headerLoginSection');
    const headerUserEmail = document.getElementById('headerUserEmail');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    const sidebarLoginBtn = document.getElementById('sidebarLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    const userInitial = document.getElementById('userInitial');
    const userInfo = document.getElementById('userInfo');
    const guestMessage = document.getElementById('guestMessage');
    const searchSection = document.getElementById('searchSection');
    const historySection = document.getElementById('historySection');

    function checkAuthStatus() {
      const user = localStorage.getItem('chat_user');
      if (user) {
        isLoggedIn = true;
        currentUser = user;
        loadUserChats();
        updateUIForLoggedInUser();
      } else {
        isLoggedIn = false;
        currentUser = '';
        chats = [];
        updateUIForGuestUser();
      }
    }

    function updateUIForLoggedInUser() {
      headerLoginSection.classList.add('hidden');
      headerUserSection.classList.remove('hidden');
      headerUserEmail.textContent = currentUser;
      
      guestMessage.classList.add('hidden');
      userInfo.classList.remove('hidden');
      searchSection.classList.remove('hidden');
      historySection.classList.remove('hidden');
      
      userEmail.textContent = currentUser;
      userInitial.textContent = currentUser.charAt(0).toUpperCase();
      logoutBtn.classList.remove('hidden');
      
      updateChatHistory();
    }

    function updateUIForGuestUser() {
      headerLoginSection.classList.remove('hidden');
      headerUserSection.classList.add('hidden');
      
      userInfo.classList.add('hidden');
      guestMessage.classList.remove('hidden');
      searchSection.classList.add('hidden');
      historySection.classList.add('hidden');
      
      chatHistory.innerHTML = '';
    }

    function loadUserChats() {
      if (isLoggedIn) {
        chats = JSON.parse(localStorage.getItem(`sarraChats_${currentUser}`) || '[]');
      }
    }

    function saveChats() {
      if (isLoggedIn) {
        localStorage.setItem(`sarraChats_${currentUser}`, JSON.stringify(chats));
      }
    }

    function logout() {
      localStorage.removeItem('chat_user');
      isLoggedIn = false;
      currentUser = '';
      chats = [];
      currentChatId = null;
      
      updateUIForGuestUser();
      startNewChat();
    }

    function redirectToAuth() {
      window.location.href = 'auth.html';
    }

    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      document.getElementById('mainContent').style.marginLeft = '320px';
      document.getElementById('openSidebar').style.display = 'none';
    }

    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      document.getElementById('mainContent').style.marginLeft = '0px';
      document.getElementById('openSidebar').style.display = 'block';
    }

    messageInput.addEventListener('keydown', function(e) {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendButton.click();
      }
    });

    chatInput.addEventListener('keydown', function(e) {
      if(e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatSendButton.click();
      }
    });

    sendButton.addEventListener('click', sendMessage);

    chatSendButton.addEventListener('click', () => {
      const message = chatInput.value.trim();
      if (!message) return;
      addMessage('user', message);
      chatInput.value = '';
      
      showLoader();
      setTimeout(() => {
        hideLoader();
        const botResponse = generateBotResponse(message);
        addMessage('bot', botResponse);
        addRateButton();
      }, 2000);
    });

    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      welcomeScreen.classList.add('hidden');
      chatMessages.classList.remove('hidden');
      questionBlock.classList.remove('hidden');

      addMessage('user', message);

      messageInput.value = '';
      messageInput.style.height = 'auto';

      showLoader();
      setTimeout(() => {
        hideLoader();
        const botResponse = generateBotResponse(message);
        addMessage('bot', botResponse);
        addRateButton();
      }, 2000);

      if (!currentChatId && isLoggedIn) {
        createNewChat(message);
      }
    }

    function addMessage(sender, text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
      const messageContent = document.createElement('div');
      messageContent.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
        sender === 'user' ? 'bg-gray-600 text-white' : 'bg-white border border-gray-300 text-gray-800'
      }`;
      messageContent.textContent = text;
      messageDiv.appendChild(messageContent);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addRateButton() {
      const existingRateButton = document.querySelector('[id^="rateAnswerBtn"]');
      if (existingRateButton) {
        existingRateButton.remove();
      }

      const rateDiv = document.createElement('div');
      rateDiv.className = 'chat-message flex justify-start mt-2';
      const uniqueId = `rateAnswerBtn-${Date.now()}`; 
      rateDiv.innerHTML = `
        <button id="${uniqueId}" class="flex items-center gap-2 px-3 py-1 rate-button rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
          </svg>
          <span>Оценить ответ</span>
        </button>
      `;
      chatMessages.appendChild(rateDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      document.getElementById(uniqueId).addEventListener('click', showRatingBlock);
    }

    function showLoader() {
      const loaderDiv = document.createElement('div');
      loaderDiv.id = 'loader';
      loaderDiv.className = 'chat-message flex justify-start';
      loaderDiv.innerHTML = `
        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-gray-300 flex items-center gap-2">
          <div class="loader"></div>
          <span class="text-gray-700">Генерируется ответ...</span>
        </div>
      `;
      chatMessages.appendChild(loaderDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideLoader() {
      const loader = document.getElementById('loader');
      if (loader) loader.remove();
    }

    function generateBotResponse(question) {
      const responses = [
        'Для этого потребуется предоставить необходимые документы лично в НАО «Государственная корпорация «Правительство для граждан» или территориальное подразделение МВД РК. Услуга доступна как в обычном, так и в ускоренном порядке, в зависимости от ситуации.'
      ];
      return responses[Math.floor(Math.random() * responses.length)];
    }

    function showRatingBlock() {
      ratingBlock.classList.remove('hidden');
      modalOverlay.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function hideRatingBlock() {
      ratingBlock.classList.add('hidden');
      modalOverlay.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      document.getElementById('commentInput').value = '';
      currentRating = 0;
      updateStars();
    }

    document.getElementById('starRating').addEventListener('click', function(e) {
      if (e.target.classList.contains('star')) {
        currentRating = parseInt(e.target.dataset.rating);
        updateStars();
      }
    });

    function updateStars() {
      const stars = document.querySelectorAll('.star');
      stars.forEach((star, index) => {
        if (index < currentRating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    closeRatingModal.addEventListener('click', hideRatingBlock);
    modalOverlay.addEventListener('click', hideRatingBlock);

    document.getElementById('submitFeedback').addEventListener('click', function() {
      const comment = document.getElementById('commentInput').value.trim();
      
      if (!comment) {
        alert('Пожалуйста, оставьте отзыв');
        return;
      }

      if (currentRating === 0) {
        alert('Пожалуйста, поставьте оценку');
        return;
      }

      const isValid = Math.random() > 0.3; 
      showValidationResult(isValid);
      hideRatingBlock();
    });

    function showValidationResult(isValid) {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'chat-message flex justify-start mt-2';
      
      if (isValid) {
        resultDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-gray-300 flex items-center gap-2 text-green-700">
            <span class="font-medium">Принято (валидация пройдена)</span>
          </div>
        `;
      } else {
        const reasons = [
          'Фидбэк содержит ненормативную лексику',
          'Отзыв слишком короткий',
          'Обнаружен спам-контент',
          'Требуется более детальная обратная связь'
        ];
        const reason = reasons[Math.floor(Math.random() * reasons.length)];
        
        resultDiv.innerHTML = `
          <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg bg-white border border-gray-300 text-red-700">
            <div class="font-medium mb-1">Отклонено (валидация не пройдена)</div>
            <div class="text-sm">${reason}</div>
          </div>
        `;
      }

      chatMessages.appendChild(resultDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      setTimeout(() => {
        resultDiv.remove();
      }, 3000);
    }

    function createNewChat(firstMessage) {
      if (!isLoggedIn) return;
      
      const chatId = Date.now().toString();
      const chat = {
        id: chatId,
        title: firstMessage.substring(0, 30) + (firstMessage.length > 30 ? '...' : ''),
        messages: [],
        createdAt: new Date().toISOString()
      };
      
      chats.unshift(chat);
      currentChatId = chatId;
      saveChats();
      updateChatHistory();
    }

    function startNewChat() {
      currentChatId = null;
      
      chatMessages.innerHTML = '';
      chatMessages.classList.add('hidden');
      welcomeScreen.classList.remove('hidden');
      questionBlock.classList.add('hidden');
      
      messageInput.value = '';
      chatInput.value = '';
      document.getElementById('commentInput').value = '';
      currentRating = 0;
      updateStars();
      
      closeSidebar();
    }

    function updateChatHistory() {
      if (!isLoggedIn) {
        chatHistory.innerHTML = '';
        return;
      }
      
      chatHistory.innerHTML = '';
      
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item p-3 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors relative group';
        chatItem.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0" onclick="loadChat('${chat.id}')">
              <div class="font-medium text-sm text-gray-200 mb-1 truncate">${chat.title}</div>
              <div class="text-xs text-gray-400">${new Date(chat.createdAt).toLocaleDateString()}</div>
            </div>
            <button class="delete-btn ml-2 p-1 text-red-400 hover:text-red-300 hover:bg-red-900 hover:bg-opacity-30 rounded transition-colors" 
                    onclick="deleteChat('${chat.id}', event)" title="Удалить чат">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        `;
        
        chatHistory.appendChild(chatItem);
      });
    }

    function loadChat(chatId) {
      console.log('Загружен чат:', chatId);
      closeSidebar();
    }

    function deleteChat(chatId, event) {
      event.stopPropagation(); 
      
      const chat = chats.find(c => c.id === chatId);
      if (!chat) return;

      const isConfirmed = confirm(`Вы уверены, что хотите удалить чат "${chat.title}"?`);
      if (!isConfirmed) return;

      const chatElements = document.querySelectorAll('.chat-item');
      let chatElement = null;
      
      chatElements.forEach(element => {
        const deleteBtn = element.querySelector('.delete-btn');
        if (deleteBtn && deleteBtn.getAttribute('onclick').includes(chatId)) {
          chatElement = element;
        }
      });

      if (chatElement) {
        chatElement.classList.add('deleting');
        
        setTimeout(() => {
          chats = chats.filter(c => c.id !== chatId);
          saveChats();
          
          if (currentChatId === chatId) {
            startNewChat();
          }
          
          updateChatHistory();
        }, 300);
      } else {
        chats = chats.filter(c => c.id !== chatId);
        saveChats();
        
        if (currentChatId === chatId) {
          startNewChat();
        }
        
        updateChatHistory();
      }
    }

    openSidebarBtn.addEventListener('click', openSidebar);
    closeSidebarBtn.addEventListener('click', closeSidebar);
    newChatBtn.addEventListener('click', startNewChat);
    headerLoginBtn.addEventListener('click', redirectToAuth);
    sidebarLoginBtn.addEventListener('click', redirectToAuth);
    headerLogoutBtn.addEventListener('click', logout);
    logoutBtn.addEventListener('click', logout);

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const chatItems = chatHistory.children;
      
      Array.from(chatItems).forEach(item => {
        const titleElement = item.querySelector('.font-medium');
        if (titleElement) {
          const title = titleElement.textContent.toLowerCase();
          if (title.includes(searchTerm)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        }
      });
    });

    window.loadChat = loadChat;
    window.deleteChat = deleteChat;

    checkAuthStatus();
  </script>
</body>
</html>